<% if !sheetsLocked %>
  <%= link_to 'Add Skill', new_player_character_characterskill_path(character_id: @character.id), remote: true %>
<% end %>
<table border = 1>
<tr>
    <th>Name</th>
    <th>Count</th>
    <th>Tier</th>
    <th>Group</th>
    <th>Rest Type</th>
    <th>Incant</th>
    <th>Description</th>
    <th></th>
</tr>
<% @character.characterskills.select("skill_id, skills.tier, skills.name, max(acquiredate) as acquiredate").joins('INNER JOIN skills ON skills.id = characterskills.skill_id').group("skill_id, skills.tier, skills.name").order('tier, name asc').each do |characterskill| %>
  <tr>
      <td><%= characterskill.skill.name %></td>
      <td><%= @character.characterskills.select("skill_id").group("skill_id").count[characterskill.skill_id] %></td>
      <td><%= characterskill.skill.tier %></td>
      <td><%= characterskill.skill.skillgroup.name %></td>
      <td><%= characterskill.skill.resttype.name %></td>
      <td><%= characterskill.skill.incant %></td>
      <td><%= characterskill.skill.description %> </td>
      <td>
      <%=
        if(canRefundSkill(@character, characterskill))
          refundprice = refundPrice(@character, characterskill)
          if (refundprice == 0)
            link_to player_character_characterskill_path(character_id: @character.id, id: characterskill.skill_id), method: :delete do 
              fa_icon "trash" 
             end
          else
            link_to player_character_characterskill_path(character_id: @character.id, id: characterskill.skill_id), method: :delete, data: { confirm: 'Doing this will cost you ' + refundprice.to_s + ' exp. This is irreversible.' } do 
              fa_icon "trash" 
            end
          end
        end
      %>
      </td>
    </tr>
  <% end %>
  </table>