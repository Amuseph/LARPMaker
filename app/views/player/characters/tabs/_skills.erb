<% if !Setting.sheets_locked %>
  <%= link_to 'Add Skill', new_player_character_characterskill_path(character_id: @character.id), remote: true %>
<% end %>
<table border = 1>
<tr>
    <th>Name</th>
    <th>Count</th>
    <th>Tier</th>
    <th>Group</th>
    <th>Rest Type</th>
    <th>Incant</th>
    <th>Description</th>
    <th></th>
</tr>
<% @character.characterskills.select("skill_id, max(aquiredate) as aquiredate").group("skill_id").each do |characterskill| %>
    <tr>
      <td><%= characterskill.skill.name %></td>
      <td><%= @character.characterskills.select("skill_id").group("skill_id").count[characterskill.skill_id] %></td>
      <td><%= characterskill.skill.tier %></td>
      <td><%= characterskill.skill.skillgroup.name %></td>
      <td><%= characterskill.skill.resttype.name %></td>
      <td><%= characterskill.skill.incant %></td>
      <td><%= characterskill.skill.description %> </td>
      <td>
      <%=
        if (@character.events.where('startdate < ?', Time.now).maximum(:startdate).nil?) || !(@character.events.where('startdate < ?', Time.now).maximum(:startdate) > characterskill.aquiredate)
          link_to player_character_characterskill_path(character_id: @character.id, id: characterskill.skill_id), method: :delete do 
            fa_icon "trash" 
           end
        elsif characterskill.skill.tier == 0
           # Do nothing. You cant refund Tier 0
        elsif @character.explogs.where('aquiredate <= ? ', Time.now.end_of_day ).sum(:amount) < characterskill.skill.tier * 25
          # Do nothing. You cant refund Tier 0
        else
          delmessage = 'Doing this will cost you ' + (characterskill.skill.tier * 25).to_s + ' exp. This is irreversible.'
          link_to player_character_characterskill_path(character_id: @character.id, id: characterskill.skill_id), method: :delete, data: { confirm: delmessage  } do 
            fa_icon "trash" 
          end
        end

      %>
      </td>
    </tr>
  <% end %>
  </table>

  <div class="modal fade" id="characterSkillModal" tabindex="-1" role="dialog" aria-labelledby="characterSkillModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="characterSkillModalLabel">Add Experience</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div> 
      <div class="modal-body">
      </div>
    </div>
  </div>
</div>